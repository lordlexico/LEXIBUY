<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LEXIBUY — Green & Dark</title>

<!-- Supabase SDK must load before our script runs -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg:#071017;
  --panel:#0f1a1c;
  --muted:#9aa9a6;
  --accent:#2ECC71;
  --accent-2:#24b66b;
  --card-shadow:0 8px 30px rgba(0,0,0,0.45);
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,Arial,sans-serif;background:var(--bg);color:#e6f0ee;-webkit-font-smoothing:antialiased}
.navbar{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--panel);gap:12px;flex-wrap:wrap}
.logo{font-weight:800;color:var(--accent);letter-spacing:1px;font-size:20px}
.search{padding:9px 12px;border-radius:10px;border:0;background:#072023;color:#dff1e7;width:360px;max-width:100%}
.account{font-size:14px;color:var(--muted);cursor:pointer;white-space:nowrap}
.hero{text-align:center;padding:34px 18px}
.hero h1{margin:0;color:var(--accent);font-size:32px}
.hero p{margin:8px 0 18px;color:var(--muted)}
.cta{background:var(--accent);color:#042017;border:0;padding:10px 18px;border-radius:10px;font-weight:700;cursor:pointer}
.categories-container{position:relative;margin:6px 0}
.categories{display:flex;gap:12px;padding:14px 20px;overflow-x:auto;scroll-behavior:smooth;-webkit-overflow-scrolling:touch}
.cat-btn{background:var(--panel);border:0;padding:8px 14px;border-radius:12px;color:var(--accent);white-space:nowrap;cursor:pointer;flex-shrink:0}
.cat-btn.active{background:var(--accent);color:#042017}
.main{max-width:1100px;margin:6px auto;padding:0 14px}
.product-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px;padding:18px 0}
.product-card{background:var(--panel);border-radius:12px;overflow:hidden;display:flex;flex-direction:column;justify-content:space-between;box-shadow:var(--card-shadow)}
.product-card img{width:100%;height:150px;object-fit:cover;background:#031011}
.product-info{padding:12px;flex:1;display:flex;flex-direction:column}
.product-info h3{margin:0 0 8px;font-size:16px}
.product-info p{margin:0 0 10px;color:var(--muted);font-size:13px;min-height:36px}
.price{font-weight:800;color:var(--accent)}
.product-row{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
.btn{background:var(--accent);color:#042017;border:0;padding:9px 12px;border-radius:10px;cursor:pointer;font-weight:700}
.btn.secondary{background:#2b3b36;color:#e6f0ee}

/* overlays */
.overlay{position:fixed;inset:0;background:rgba(2,8,10,0.82);display:none;align-items:center;justify-content:center;z-index:9999}
.card{background:linear-gradient(180deg,var(--panel),#071619);padding:18px;border-radius:12px;width:94%;max-width:520px;color:#eaf7ee;box-shadow:var(--card-shadow);position:relative}
.card h2{margin:0 0 12px;color:var(--accent)}
.card input, .card textarea, .card select{width:100%;padding:10px;border-radius:8px;border:0;background:#031718;color:#eafff3;margin:8px 0; font-size:15px}
.card textarea{min-height:90px;resize:vertical}
.actions{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
.muted{color:var(--muted);font-size:13px;margin-top:8px}
#googleLoginBtn{width:100%;padding:10px;background:#34A853;color:white;font-weight:700;border-radius:8px;border:none;margin-top:8px;cursor:pointer}
#googleLoginBtn:hover{background:#2e9e4d}

/* Upload form special */
#uploadForm{display:flex;flex-direction:column}
#progressWrap{width:100%;background:#0b1514;border-radius:8px;height:10px;margin-top:10px;overflow:hidden}
#progressBar{height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent-2));transition:width .2s}

/* success toast */
.toast{position:fixed;right:18px;top:18px;background:var(--accent);color:#042017;padding:10px 14px;border-radius:8px;font-weight:700;display:none;box-shadow:0 6px 20px rgba(0,0,0,0.5);z-index:10000}

/* responsive */
@media(max-width:760px){
  .search{width:100%}
  .hero h1{font-size:22px}
  .product-card img{height:120px}
  .navbar{padding:12px;gap:8px}
}
</style>
</head>
<body>

<!-- NAV -->
<div class="navbar">
  <div class="logo">LEXIBUY</div>
  <input id="searchBox" class="search" placeholder="Search items..." />
  <div style="display:flex;gap:12px;align-items:center">
    <div id="accountName" class="account">Guest</div>
    <button class="btn" id="openUploadNav">Upload</button>
  </div>
</div>

<!-- HERO -->
<section class="hero">
  <h1>Buy & Sell Digital Assets</h1>
  <p>Software, codes, images, audio and more — explore and list easily.</p>
  <button class="cta" id="openUploadHero">Upload Product</button>
</section>

<!-- CATEGORIES -->
<div class="main">
  <div class="categories-container">
    <div id="categoryBar" class="categories">
      <button class="cat-btn active" data-cat="all">All</button>
      <button class="cat-btn" data-cat="Software">Software</button>
      <button class="cat-btn" data-cat="Codes">Codes</button>
      <button class="cat-btn" data-cat="Audio">Audio</button>
      <button class="cat-btn" data-cat="Images">Images</button>
      <button class="cat-btn" data-cat="Documents">Documents</button>
      <button class="cat-btn" data-cat="Templates">Templates</button>
      <button class="cat-btn" data-cat="Tools">Tools</button>
    </div>
  </div>

  <div id="productGrid" class="product-grid"></div>
</div>

<footer style="padding:18px;text-align:center;color:var(--muted)">© 2025 LEXIBUY — All rights reserved.</footer>

<!-- AUTH OVERLAY -->
<div id="authOverlay" class="overlay" aria-hidden="true">
  <div class="card" role="dialog" aria-modal="true">
    <h2>Sign In / Sign Up</h2>
    <input id="authEmail" type="email" placeholder="Email address" autocomplete="email" />
    <div class="actions">
      <button id="authMagic" class="btn">Send Magic Link</button>
      <button id="googleLoginBtn">Continue with Google</button>
      <button class="btn secondary" id="authCancel">Cancel</button>
    </div>
    <div class="muted">Use email magic link or Google. After login you can upload.</div>
  </div>
</div>

<!-- UPLOAD OVERLAY -->
<div id="uploadOverlay" class="overlay" aria-hidden="true">
  <div class="card">
    <h2>Upload Product</h2>
    <form id="uploadForm">
      <input id="title" placeholder="Title" required />
      <textarea id="description" placeholder="Short description (optional)"></textarea>
      <input id="price" type="number" placeholder="Price (USD)" required />
      <input id="category" placeholder="Category (e.g. Software)" required />
      <input id="file" type="file" accept="*/*" required />
      <div class="actions">
        <button id="doUpload" class="btn" type="button">Upload</button>
        <button id="cancelUpload" class="btn secondary" type="button">Cancel</button>
      </div>
      <div id="progressWrap"><div id="progressBar"></div></div>
    </form>
    <div class="muted">Files are stored in your Supabase storage bucket `product-assets`.</div>
  </div>
</div>

<div id="toast" class="toast">Uploaded ✓</div>

<script>
/* -----------------------------
   CONFIG - YOUR KEYS & SETTINGS
   -----------------------------
   These are the exact values you confirmed earlier.
*/
const SUPABASE_URL = 'https://aqorvefjdlzliubfnxss.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFxb3J2ZWZqZGx6bGl1YmZueHNzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyMTIwNDQsImV4cCI6MjA4MDc4ODA0NH0.OLDGmb53Bd9MDVQgx-6DcTtC9PaPUQwb3LjmDODHeno';

// set the exact redirect URL you added to Google & Supabase
const OAUTH_REDIRECT = 'https://lordlexico.github.io/LEXIBUY/';

// initialize client with a distinct variable name (avoids "before initialization" errors)
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* -----------------------------
   DOM refs
*/
const authOverlay = document.getElementById('authOverlay');
const uploadOverlay = document.getElementById('uploadOverlay');
const accountNameEl = document.getElementById('accountName');
const productGrid = document.getElementById('productGrid');
const searchBox = document.getElementById('searchBox');
const categoryBar = document.getElementById('categoryBar');
const toast = document.getElementById('toast');
const progressBar = document.getElementById('progressBar');

/* -----------------------------
   Helpers: open/close overlays
*/
function showAuth(){ authOverlay.style.display='flex'; authOverlay.setAttribute('aria-hidden','false'); }
function hideAuth(){ authOverlay.style.display='none'; authOverlay.setAttribute('aria-hidden','true'); }
function showUpload(){ uploadOverlay.style.display='flex'; uploadOverlay.setAttribute('aria-hidden','false'); }
function hideUpload(){ uploadOverlay.style.display='none'; uploadOverlay.setAttribute('aria-hidden','true'); }
function showToast(msg='Done'){ toast.innerText = msg; toast.style.display='block'; setTimeout(()=> toast.style.display='none', 2400); }

/* -----------------------------
   UI wiring
*/
document.getElementById('openUploadNav').addEventListener('click', ()=> requireLogin(showUpload));
document.getElementById('openUploadHero').addEventListener('click', ()=> requireLogin(showUpload));
document.getElementById('authCancel').addEventListener('click', hideAuth);
document.getElementById('cancelUpload').addEventListener('click', hideUpload);

/* categories */
categoryBar.querySelectorAll('.cat-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    categoryBar.querySelectorAll('.cat-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    fetchProducts();
  });
});

/* search */
searchBox.addEventListener('input', ()=> {
  if(window._searchTimeout) clearTimeout(window._searchTimeout);
  window._searchTimeout = setTimeout(fetchProducts, 250);
});

/* -----------------------------
   AUTH: Magic Link + Google
*/
document.getElementById('authMagic').addEventListener('click', async ()=>{
  const email = document.getElementById('authEmail').value.trim();
  if(!email) return alert('Enter your email.');
  const { data, error } = await supabaseClient.auth.signInWithOtp({
    email,
    options: { emailRedirectTo: OAUTH_REDIRECT }
  });
  if(error) return alert('Magic link error: ' + error.message);
  alert('Magic link sent — check your email.');
  hideAuth();
});

// Google OAuth
document.getElementById('googleLoginBtn').addEventListener('click', async ()=>{
  const { error } = await supabaseClient.auth.signInWithOAuth({
    provider: 'google',
    options: { redirectTo: OAUTH_REDIRECT }
  });
  if(error) alert('Google login error: ' + error.message);
});

/* Listen for auth changes (works for magic link & OAuth) */
supabaseClient.auth.onAuthStateChange((event, session) => {
  if(session?.user){
    accountNameEl.innerText = session.user.email;
    // hide overlays if any
    hideAuth();
    hideUpload();
  }
});

/* On load, check session (keeps users logged in) */
(async function initSession(){
  try{
    const { data } = await supabaseClient.auth.getSession();
    const user = data.session?.user;
    if(user) accountNameEl.innerText = user.email;
  }catch(e){ console.warn('session check failed', e); }
})();

/* clicking account shows auth overlay or user info */
accountNameEl.addEventListener('click', async ()=>{
  const { data } = await supabaseClient.auth.getSession();
  if(data.session?.user) alert('Logged in as: ' + data.session.user.email);
  else showAuth();
});

/* -----------------------------
   UPLOAD
*/
document.getElementById('doUpload').addEventListener('click', ()=> requireLogin(uploadProduct));

async function requireLogin(cb){
  const { data: { session } } = await supabaseClient.auth.getSession();
  if(session?.user) return cb();
  showAuth();
  // wait for auth state change once
  const sub = supabaseClient.auth.onAuthStateChange((event, session)=>{
    if(session?.user){
      sub.subscription.unsubscribe();
      accountNameEl.innerText = session.user.email;
      hideAuth();
      cb();
    }
  });
}

async function uploadProduct(){
  try{
    const { data: { session } } = await supabaseClient.auth.getSession();
    const user = session?.user;
    if(!user) return alert('You must be logged in to upload.');

    const title = document.getElementById('title').value.trim();
    const description = document.getElementById('description').value.trim();
    const price = document.getElementById('price').value;
    const category = document.getElementById('category').value.trim();
    const file = document.getElementById('file').files?.[0];

    if(!title || !price || !category || !file) return alert('Fill all fields.');

    // Reset & simulate progress
    progressBar.style.width = '6%';

    // create unique filename
    const ext = file.name.split('.').pop();
    const filename = `${Date.now()}-${Math.random().toString(36).slice(2,8)}.${ext}`;
    const path = `products/${filename}`;

    // Upload to Supabase storage (bucket: product-assets)
    const { data: uploadData, error: uploadErr } = await supabaseClient.storage.from('product-assets').upload(path, file);
    if(uploadErr) throw new Error(uploadErr.message);

    progressBar.style.width = '62%';

    // get public URL
    const { data: urlData } = supabaseClient.storage.from('product-assets').getPublicUrl(path);
    const publicUrl = urlData.publicUrl;

    progressBar.style.width = '82%';

    // insert into Products table
    const { error: insertErr } = await supabaseClient.from('Products').insert([{
      title,
      description,
      price,
      category,
      image_url: publicUrl,
      seller_id: user.id,  // FIXED
      approved: true
    }]);  <!-- ONLY CHANGE: the "u" is gone -->

    if(insertErr) throw new Error(insertErr.message);

    progressBar.style.width = '100%';
    showToast('Upload successful');

    // reset form
    document.getElementById('uploadForm').reset();
    setTimeout(()=> progressBar.style.width = '0%', 600);

    // refresh product list
    hideUpload();
    fetchProducts();
  }catch(err){
    alert('Upload failed: ' + (err.message || err));
    progressBar.style.width = '0%';
  }
}

/* -----------------------------
   PRODUCTS: fetch & render
*/
async function fetchProducts(){
  try{
    const search = (searchBox.value || '').toLowerCase();
    const activeCat = categoryBar.querySelector('.cat-btn.active')?.dataset?.cat || 'all';
    const { data, error } = await supabaseClient.from('Products').select('*').eq('approved', true).order('id', { ascending: false });
    if(error) throw error;
    let items = data || [];
    items = items.filter(p=>{
      const matchesCat = activeCat === 'all' || (p.category||'').toLowerCase() === activeCat.toLowerCase();
      const matchesSearch = !search || (p.title||'').toLowerCase().includes(search) || (p.category||'').toLowerCase().includes(search);
      return matchesCat && matchesSearch;
    });
    renderProducts(items);
  }catch(err){
    productGrid.innerHTML = `<div style="padding:16px;color:var(--muted)">Error loading products.</div>`;
    console.error(err);
  }
}

function renderProducts(items){
  productGrid.innerHTML = '';
  if(items.length === 0){
    productGrid.innerHTML = `<div style="padding:18px;color:var(--muted)">No products found.</div>`;
    return;
  }
  items.forEach(p=>{
    const card = document.createElement('div');
    card.className = 'product-card';
    const title = escapeHtml(p.title);
    const desc = escapeHtml(p.description || '');
    const img = p.image_url || '';
    const price = escapeHtml(p.price);
    card.innerHTML = `<img src="${img}" alt="${title}">
      <div class="product-info">
        <div>
          <h3>${title}</h3>
          <p>${desc}</p>
        </div>
        <div class="product-row">
          <div class="price">$${price}</div>
          <button class="btn buy-btn">Buy</button>
        </div>
      </div>`;
    card.querySelector('.buy-btn').addEventListener('click', ()=> requireLogin(()=> alert('Ready to buy: ' + p.title)));
    productGrid.appendChild(card);
  });
}

function escapeHtml(s){ if(s===undefined||s===null) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

/* -----------------------------
   initial load
*/
fetchProducts();

</script>
</body>
  </html>
